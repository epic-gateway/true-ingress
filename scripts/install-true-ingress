#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# TrueIngress adhoc Linux installation script.

# We need to download files from private Gitlab repos so we need an
# access token.
TOKEN=${1:-}

if [ "X$TOKEN" = "X" ] ; then
    echo "A Gitlab access token must be provided"
    exit 1
fi

# Create directories
mkdir -p /etc/kubernetes /opt/acnodal/bin

# Add our tools to the PATH, and tell kubectl where to find its config
cat > /etc/profile.d/acnodal.sh <<HERE
export PATH="\$PATH:/opt/acnodal/bin"
export KUBECONFIG=/etc/kubernetes/admin.conf
HERE

# Download epicctl
wget --no-verbose --header="PRIVATE-TOKEN: $TOKEN" --output-document=/opt/acnodal/bin/epicctl https://gitlab.com/api/v4/projects/acnodal%2Fepic%2Fepicctl/packages/generic/epicctl/v0.9.0/epicctl
chmod +x /opt/acnodal/bin/epicctl

# Download true ingress binaries
wget --no-verbose --header="PRIVATE-TOKEN: $TOKEN" --output-document=- https://gitlab.com/api/v4/projects/acnodal%2Fepic%2Ftrue-ingress/packages/generic/true-ingress/v0.18.1/true-ingress.tar.bz2 | tar xjvf - -C /opt/acnodal

# Install and start systemd service file for the GUE ping program
wget --no-verbose --header="PRIVATE-TOKEN: $TOKEN" --output-document=/usr/lib/systemd/system/gue_ping_svc_auto.service https://gitlab.com/api/v4/projects/acnodal%2Fepic%2Ftrue-ingress/packages/generic/true-ingress/v0.18.1/gue_ping_svc_auto.service
systemctl enable gue_ping_svc_auto
systemctl start gue_ping_svc_auto

# Download the manager
wget --no-verbose --header="PRIVATE-TOKEN: $TOKEN" --output-document=/opt/acnodal/bin/manager https://gitlab.com/api/v4/projects/acnodal%2Fepic%2Fresource-model/packages/generic/manifest-package/v0.52.0/manager
chmod +x /opt/acnodal/bin/manager

# Install and start systemd service file for the manager
wget --no-verbose --header="PRIVATE-TOKEN: $TOKEN" --output-document=/usr/lib/systemd/system/manager.service https://gitlab.com/api/v4/projects/acnodal%2Fepic%2Fresource-model/packages/generic/manifest-package/v0.52.0/manager.service
systemctl enable manager
systemctl start manager

# Make executable binaries executable
chmod +x /opt/acnodal/bin/epicctl /opt/acnodal/bin/manager

# The user needs to do this:
echo
echo \*\*\* Installation almost complete
echo
echo \*\*\* You need to upload a kubectl config file to /etc/kubernetes/admin.conf
echo \*\*\* Then run "source /etc/profile.d/acnodal.sh" to set up your environment
echo
echo \*\*\* You also need to edit /usr/lib/systemd/system/manager.service
echo \*\*\* to ensure that the command line matches your setup
